<!DOCTYPE html>
<head>
    <meta charset="utf-8">

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="css/plugins/switchery/switchery.css" rel="stylesheet">
    <link href="css/plugins/ionRangeSlider/ion.rangeSlider.css" rel="stylesheet">
    <link href="css/plugins/ionRangeSlider/ion.rangeSlider.skinHTML5.css" rel="stylesheet">

    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/simulator.css" /><!--自定义样式-->
    <link rel="icon" href="images/favicon.png" />
    <script src="dist/main.js"></script>
    <link rel="stylesheet" href="css/dat-gui.css" />
    <title>Tongji Traffic Simulator</title>
</head>
<body>
    <div id="wrapper">
        <nav class="navbar-default navbar-static-side" role="navigation">
            <div class="sidebar-collapse">
                <ul class="nav" id="side-menu">
                    <li class="nav-header">
                        <div class="dropdown profile-element"> <span>
                            <img alt="Tongji University" src="images/tongji.jpg" width="100%" />
                             </span>
                            <a data-toggle="dropdown" class="dropdown-toggle" href="index.html#">
                            <span class="clear"> <span class="block m-t-xs"> <strong class="font-bold">Tongji Traffic Simulator</strong></span>
                            <span class="text-muted text-xs block">min.zhu <b class="caret"></b></span> </span> </a>
                            <ul class="dropdown-menu animated fadeInRight m-t-xs">
                                <li><a href="profile.html">Profile</a></li>
                                <li><a href="contacts.html">Contacts</a></li>
                                <li><a href="mailbox.html">Mailbox</a></li>
                                <li class="divider"></li>
                                <li><a href="login.html">Logout</a></li>
                            </ul>
                        </div>
                    </li>
                    <li class="active">
                        <a href="#home" data-toggle="tab">
                            <i class="fa fa-diamond"></i> <span class="nav-label">Home</span>
                        </a>
                    </li>
                    <li>
                        <a href="#map-builder" data-toggle="tab" id="world_builder">
                            <i class="fa fa-flask"></i> <span class="nav-label">Map Builder</span>
                        </a>
                    </li>
                    <li>
                        <a href="#simulation" data-toggle="tab" id="sim_tab">
                            <i class="fa fa-flask"></i> <span class="nav-label">Simulation</span>
                        </a>
                    </li>
                    <li>
                        <a href="#result" data-toggle="tab">
                            <i class="fa fa-bar-chart-o"></i> <span class="nav-label">Result</span>
                            <span class="label label-primary pull-right">NEW</span>
                        </a>
                    </li>
                    <li>
                        <a href="#help" data-toggle="tab">
                            <i class="fa fa-question-circle"></i> <span class="nav-label">Help</span>
                        </a>
                    </li>
                </ul>

            </div>
        </nav>

        <div id="page-wrapper" class="gray-bg tab-content">
            <!-- Home Page -->
            <div role="tabpanel" class="tab-pane active" id="home">
                <div class="row wrapper border-bottom white-bg page-heading">
                    <div class="col-lg-10">
                        <h2>Welcome to Tongji Traffic Simulator!</h2>
                    </div>
                </div>
                <br/>
                <div>
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="ibox float-e-margins">
                                <div class="ibox-title">
                                    <h5>地图选择设置</h5>
                                    <span class="label label-primary pull-right">Map Related</span>
                                    <!-- Nav tabs -->
                                </div>
                                <div class="ibox-content">
                                    <!-- Tab panes -->

                                        <div class="tab-pane" id="custom-map">
                                            <p>请先去<code>Map buider</code> 创建并导出<code>Json</code>地图,再来加载地图</p>
                                            <button type="button" id="edit-map" class="btn btn-primary">编辑地图</button>
                                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#load-json-map-modal">加载JSON格式地图</button>
                                        </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="ibox float-e-margins">
                                <div class="ibox-title">
                                    <span class="label label-success pull-right">model</span>
                                    <h5>跟车模型</h5>
                                </div>
                                <div class="ibox-content">
                                    <h1 class="no-margins">智能跟车模型</h1><br>
                                    <div class="stat-percent font-bold text-success">wiki<i class="fa fa-bolt"></i></div>
                                    <small>Total income</small>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-3">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>仿真周期设置</h5>
                                <span class="label text-success pull-right">Time Related</span>
                            </div>
                            <div class="ibox-content">
                                <input id="sim-time" type="number" class="form-control" placeholder="(默认 3600 s)【推荐】">
                                <div class="stat-percent font-bold text-success">sec <i class="fa fa-clock-o"></i></div>
                                <small>单位</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <span class="label label-info pull-right">max speed</span>
                                <h5>最大车速</h5>
                            </div>
                            <div class="ibox-content">
                                <input id="max-car-speed" type="number" class="form-control" placeholder="(默认 60 - 90 随机)【推荐】">
                                <div class="stat-percent font-bold text-info">km/h <i class="fa fa-level-up"></i></div>
                                <small>单位</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <span class="label label-primary pull-right">maxAcceleration</span>
                                <h5>最大加速度</h5>
                            </div>
                            <div class="ibox-content">
                                <input id="max-car-Acceleration" type="number" class="form-control" placeholder="(默认 2.5 - 3 随机)【推荐】">
                                <div class="stat-percent font-bold text-navy">m2/s <i class="fa fa-level-up"></i></div>
                                <small>单位</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <span class="label label-danger pull-right">maxDeceleration</span>
                                <h5>最大减速度</h5>
                            </div>
                            <div class="ibox-content">
                                <input id="max-car-Deceleration" type="number" class="form-control" placeholder="(默认 1.5 - 2 随机)【推荐】">
                                <div class="stat-percent font-bold text-danger">m2/s<i class="fa fa-level-down"></i></div>
                                <small>单位</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!--<div class="row" id="signal-help" >-->

                    <!--<div class="col-lg-9" id="signal-help-canvas">-->
                    <!--</div>-->

                <!--</div>-->

                <div class="row">

                    <div class="col-lg-12   ">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>信号控制相关</h5>
                                <span class="label label-success pull-right">Signal Related</span>
                            </div>
                            <div class="ibox-content">
                                <div class="row form-group">
                                    <div class="col-sm-3">
                                        <label class="control-label">选择路口</label>
                                        <select id="signal-control-intersection" class="form-control"></select>
                                        <label class="control-label">定时控制</label>
                                        <p><code>信号周期</code></p>
                                        <input id="signal-cycle" type="number" class="form-control" placeholder="信号周期 ...">
                                        <br>
                                        <p><code>黄灯时间</code></p>
                                        <input id="yellow-time" type="number" class="form-control" placeholder="黄灯时间 ...">
                                        <br>
                                    </div>
                                    <div class="col-sm-9">
                                        <div class="row">
                                            <div class="col-sm-2"><span class="label pull-left label-primary">东西直行 <i class="fa fa-exchange"></i></span></div>
                                            <div class="col-sm-10"><input type="text" id="signal1" name="example_name" value="" /></div>

                                        </div><br>
                                        <div class="row">
                                            <div class="col-sm-2"><span class="label pull-left label-info">东西左转 <i class="fa fa-reply"></i></span></div>
                                            <div class="col-sm-10"><input type="text" id="signal2" name="example_name" value="" /></div>

                                        </div><br>
                                        <div class="row">
                                            <div class="col-sm-2"><span class="label pull-left label-warning">南北直行 <i class="fa fa-exchange"></i></span></div>
                                            <div class="col-sm-10"><input type="text" id="signal3" name="example_name" value="" /></div>

                                        </div><br>
                                        <div class="row">
                                            <div class="col-sm-2"><span class="label pull-left label-danger">南北左转 <i class="fa fa-reply"></i></span></div>
                                            <div class="col-sm-10"><input type="text" id="signal4" name="example_name" value="" /></div>

                                        </div><br>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>

                <div class="row">
                    <div class="col-lg-9">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>车流量设置</h5>
                                <span class="label label-warning pull-right">car producer Related</span>
                            </div>
                            <div class="ibox-content">
                                <div class="row form-group">

                                    <div class="col-sm-4">
                                        <label class="control-label"><p><code>左转车流量</code></p></label>
                                        <input id="left-car" type="number" class="form-control" placeholder="左转车流 ...">
                                        <div class="stat-percent font-bold text-navy">vel/h <i class="fa fa-car"></i></div>
                                        <small>单位</small>
                                    </div>

                                    <div class="col-sm-4">
                                        <label class="control-label"><p><code>直行车流量</code></p></label>
                                        <input id="straight-car" type="number" class="form-control" placeholder="自行车流 ...">
                                        <div class="stat-percent font-bold text-navy">vel/h <i class="fa fa-car"></i></div>
                                        <small>单位</small>
                                    </div>

                                    <div class="col-sm-4">
                                        <label class="control-label"><p><code>左转车流量</code></p></label>
                                        <input id="right-car" type="number" class="form-control" placeholder="左转车流 ...">
                                        <div class="stat-percent font-bold text-navy">vel/h <i class="fa fa-car"></i></div>
                                        <small>单位</small>
                                    </div>




                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">

                        <div class="ibox-title">
                            <h5>仿真操作</h5>
                            <span class="label label-danger pull-right">start simulator</span>
                        </div>
                        <div class="ibox-content">
                            <button id="start-sim" class="btn btn-success " type="button"><i class="fa fa-arrow-right"></i>&nbsp;&nbsp;<span class="bold">开始仿真</span></button>
                        </div>


                    </div>
                </div>


            </div>
          
            <!-- Map Builder Page -->
            <div role="tabpanel" class="tab-pane" id="map-builder">
              <div class="row">
                    <div id="map-builder-canvas"></div>
                    <div class="map-builder-param ibox-content">
                        <div class="m-b">
                            <button id="clear_build_world" class="btn btn-sm btn-primary">清空</button>
                            <button id="export_build_json" class="btn btn-sm btn-primary">导出JSON</button>

                        </div>
                        <div id="select_intersection_div"  class="m-b" style="display: none">

                            <p>按住 <code>ctrl</code>键<p>
                            <p>点击交叉口，查看<code> 交叉口ID</code></p>
                            <div>
                                <span class="label label-success">交叉口ID</span>
                            </div>
                            <br>
                            <input id="select_intersection" type="text" readonly>
                            <br/>
                       </div>
                    </div>
                </div>
            </div>

            <!-- Simulation Page -->
            <div role="tabpanel" class="tab-pane" id="simulation">
                <div class="row">
                    <div id="simulation-canvas"></div>
                    <div class="simulation-param ibox-content">
                        <div class="m-b" style="line-height: 32px">
                            <label  class="label label-success" for="running">Running</label>

                            <span class="pull-right">
                                <input id="js-running" type="checkbox" name="running" class="js-running" checked />
                            </span>
                        </div>
                        <div id="sim_demo_param">
                            <div class="m-b">
                                <label>Generate</label>
                                <button id="generate-single" class="btn btn-sm btn-primary">Single</button>
                                <button id="generate-complex" class="btn btn-sm btn-primary">Complex</button>
                            </div>
                            <div class="m-b">
                                <label>Option</label>
                                <button id="export_world" class="btn btn-sm btn-primary">Save</button>
                                <button id="restart_world" class="btn btn-sm btn-primary">Load</button>
                            </div>
                            <div class="m-b">
                                <label>Cars Number</label>
                                <input type="text" id="cars_number" data-min="0" data-max="200" data-from="10">
                            </div>
                            <div class="m-b">
                                <label>Scale</label>
                                <input type="text" id="scale" data-min="0.1" data-max="2" data-from="1" data-step="0.01">
                            </div>
                            <div class="m-b">
                                <label>Time Factor</label>
                                <br>
                                <input type="text" id="timeFactor" value="5"
                                    data-min="0.1" data-max="10" data-step="0.1" data-width="85" data-height="85">
                            </div>
                         </div>
                        <div id="sim_real" class="m-b" style="display: none">
                            <div>
                                <span class="label label-success">仿 真 进 度</span>
                            </div>
                            <br/>
                            <div id="simProgress-container"></div>
                            <br>
                            <div class="m-b" style="line-height: 32px">
                                <span class="pull-left">
                                    <div>
                                        <span class="label label-danger pull-left">平均停车次数</span>
                                        <br>
                                        <input id="average_stop_time" width="100%" type="number" readonly />
                                    </div>
                                </span>
                            </div>
                            <div class="m-b" style="line-height: 32px">
                                <span class="pull-left">
                                    <div>
                                        <span class="label label-danger pull-left">停 车 比 例</span>
                                        <br>
                                        <input id="stop_rate" width="100%" type="number" readonly />
                                    </div>
                                </span>
                            </div>

                        </div>


                    </div>
                </div>
                <div class="row gray-bg simulation-graph">
                    <div class="col-sm-4">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>平均车速</h5>
                                <span class="label label-warning pull-right">Average Speed</span>
                            </div>
                            <div class="ibox-content">
                                <div class="flot-chart">
                                    <div class="flot-chart-content" id="instantSpeed-chart-moving"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>平均延误</h5>
                                <span class="label label-success pull-right">Average Delay</span>
                            </div>
                            <div class="ibox-content">
                                <div class="flot-chart">
                                    <div class="flot-chart-content" id="instantDelay-chart-moving"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>平均停车延时</h5>
                                <span class="label label-info pull-right">Average Stop Delay</span>
                            </div>
                            <div class="ibox-content">
                                <div class="flot-chart">
                                    <div class="flot-chart-content" id="instantStopTimes-chart-moving"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Result Page -->
            <div role="tabpanel" class="tab-pane" id="result">
                <div class="row wrapper border-bottom white-bg page-heading">
                    <div class="col-lg-10">
                        <h2>Simulation Result</h2>
                    </div>
                </div>
                <br/>
                <div class="row">
                    <div class="col-lg-3">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <span class="label label-success pull-left">平均延误</span>
                            </div>
                            <div class="ibox-content">
                                <h1 id="average_delay" class="no-margins">null</h1>
                                <div class="stat-percent font-bold text-success">sec <i class="fa fa-clock-o"></i></div>
                                <small>单位</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <span class="label label-info pull-left">总延误</span>
                            </div>
                            <div class="ibox-content">
                                <h1 id="total_delay" class="no-margins">null</h1>
                                <div class="stat-percent font-bold text-info">h <i class="fa fa-clock-o"></i></div>
                                <small>单位</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <span class="label label-primary pull-left">平均速度</span>
                            </div>
                            <div class="ibox-content">
                                <h1 id="average_speed" class="no-margins">null</h1>
                                <div class="stat-percent font-bold text-navy">km/h <i class="fa fa-level-up"></i></div>
                                <small>单位</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <span class="label label-danger pull-left">总通过量</span>
                            </div>
                            <div class="ibox-content">
                                <h1 id="total_car_number" class="no-margins">null</h1>
                                <div class="stat-percent font-bold text-danger">vel <i class="fa fa-car"></i></div>
                                <small>单位</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-3">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <span class="label label-success pull-left">平均停车延误</span>
                            </div>
                            <div class="ibox-content">
                                <h1 id="average_stop_delay" class="no-margins">null</h1>
                                <div class="stat-percent font-bold text-success">sec <i class="fa fa-clock-o"></i></div>
                                <small>单位</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <span class="label label-info pull-left">总停车延误</span>
                            </div>
                            <div class="ibox-content">
                                <h1 id="total_stop_delay" class="no-margins">null</h1>
                                <div class="stat-percent font-bold text-info">h <i class="fa fa-clock-o"></i></div>
                                <small>单位</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-2">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <span class="label label-primary pull-left">平均停车次数</span>
                            </div>
                            <div class="ibox-content">
                                <h2 id="average_stop_times" class="no-margins">null</h2>
                                <div class="stat-percent font-bold text-navy">time <i class="fa fa-minus-circle"></i></div>
                                <small>单位</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-2">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <span class="label label-warning pull-left">总停车次数</span>
                            </div>
                            <div class="ibox-content">
                                <h2 id="total_stop_times" class="no-margins">null</h2>
                                <div class="stat-percent font-bold text-danger">time <i class="fa fa-minus-circle"></i></div>
                                <small>单位</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-2">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <span class="label label-danger pull-left">停车比例</span>
                            </div>
                            <div class="ibox-content">
                                <h2 id="total_stop_rate" class="no-margins">null</h2>
                                <div class="stat-percent font-bold text-danger"> % <i class="fa fa-tachometer"></i></div>
                                <small>单位</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div>

                    <div class="ibox float-e-margins">
                        <div class="ibox-title">
                            <span class="label label-success pull-left">交叉口分周期信息展示图</span>
                        </div>
                        <div class="ibox-content">
                            <div class="row">
                                <div class="col-sm-2">
                                    <span class="label text-success pull-left">选择要查看的交叉口 <i class="fa fa-clock-o"></i></span>
                                </div>
                                <div class="col-sm-2">
                                    <select id="real-intersections" class="form-control"></select>
                                </div>
                            </div>

                            <br>
                            <div id="chartdiv"></div>
                        </div>
                    </div>
                </div>



            </div>

            <!-- Help Page -->
            <div role="tabpanel" class="tab-pane" id="help">
                <div class="row wrapper border-bottom white-bg page-heading">
                    <div class="col-lg-10">
                        <h2>Help</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="load-json-map-modal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">加载JSON格式地图</h4>
          </div>
          <div class="modal-body">
            <textarea class="load-json-map-textarea"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="load-json-map-btn">加载</button>
          </div>
        </div>
      </div>
    </div>

    <link rel="stylesheet" href="css/custom.css" />
    <link rel="stylesheet" href="js/plugins/amCharts/plugins/export/export.css" />
    <link rel="stylesheet" href="css/animate.css" />
    <link rel="stylesheet" media="screen" href="css/plugins/handsonTable/handsontable.full.css">

<!--    <script src="js/inspinia.js"></script>-->

    <!-- Mainly scripts -->
    <script src="js/underscore-1.8.3.js"></script>
    <script src="js/jquery-2.1.1.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <!-- Flot -->
    <script src="js/plugins/flot/jquery.flot.js"></script>
    <script src="js/plugins/flot/jquery.flot.tooltip.min.js"></script>
    <script src="js/plugins/flot/jquery.flot.resize.js"></script>
    <script src="js/plugins/flot/jquery.flot.pie.js"></script>
    <script src="js/plugins/flot/jquery.flot.time.js"></script>

    <!-- Form -->
    <script src="js/plugins/switchery/switchery.js"></script>
    <script src="js/plugins/ionRangeSlider/ion.rangeSlider.min.js"></script>
    <script src="js/plugins/jsKnob/jquery.knob.js"></script>
    <script src="js/plugins/iCheck/icheck.min.js"></script>
    <script src="js/plugins/pace/pace.min.js"></script>
    <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

    <script src="js/plugins/handsonTable/handsontable.full.js"></script>
    <script src="js/plugins/progressbar/progressbar.js"></script>

    <script src="js/plugins/amCharts/amcharts.js"></script>
    <script src="js/plugins/amCharts/serial.js"></script>
    <script src="js/plugins/amCharts/themes/dark.js"></script>
    <script src="js/plugins/amCharts/plugins/export/export.js"></script>


    <script type="text/javascript">

    var world = window.world;
    var visualizer = window.visualizer;
    var settings = window.settings;

    var isDemo = true;

    var signalSettings = {};

    var mapJson = {};

    var sim_time = 0;

$(function(){

    function downloadFile(fileName, content){
        var aLink = document.createElement('a');
        var blob = new Blob([content]);
        var evt = document.createEvent("HTMLEvents");
        evt.initEvent("click", false, false);//initEvent 不加后两个参数在FF下会报错, 感谢 Barret Lee 的反馈
        aLink.download = fileName;
        aLink.href = URL.createObjectURL(blob);
        aLink.dispatchEvent(evt);
    }

    $('#clear_build_world').click(function () {
        window.builderWorld.clear();
    });

    $('#export_build_json').click(function () {
        window.builderWorld.save();
        downloadFile("map.json",localStorage.world);

        $('#select_intersection_div').show();
        setInterval(function showIntersecionId(){
            $("#select_intersection").val(localStorage.selectedIntersectionId);
        }, 50);
    });

    $('#edit-map').click(function(){
        $("#world_builder").click();
    });

});

var elem = document.querySelector('.js-running');
var isRunning = new Switchery(elem, { color: '#1AB394' });
$(function() {

    elem.addEventListener('change', function () {
        visualizer.running = this.checked;
    });

    $('#sim_tab').click(function (){
        if (!isDemo){
            $('#sim_demo_param').hide();
            $('#sim_real').show();
        }
        $('#wrapper').scrollTop(0);
    });

    $('#world_builder').click(function (){
        $('#wrapper').scrollTop(0);
    });

    $('#home').click(function (){
        $('#wrapper').scrollTop(0);
    });

    $('#result').click(function (){
        $('#wrapper').scrollTop(0);
    });



//    $('#home').click(function (){
//
//    });

    $('#export_world').click(function () {
        world.save();
        world.clear();
    });
    $('#restart_world').click(function () {
        world.load();
    });

    $('#generate-single').click(function () {
        visualizer.previousTime = 0;
        world.generateSingleCrossRoadMap();
        visualizer.start(false)
    });
    $('#generate-complex').click(function () {
        visualizer.previousTime = 0;
        world.generateCrossRoadMap();
        visualizer.start(false)
    });

    $('#cars_number').ionRangeSlider({
        onChange: function (v) { world.carsNumber = v.from; }
    });
    $('#scale').ionRangeSlider({
        onChange: function (v) { visualizer.zoomer.scale = v.from; }
    });

    $("#timeFactor").knob({
        'release' : function (v) { visualizer.timeFactor = v; }
    });
    $("#lightsFlipIntervalGreen").knob({
        'release' : function (v) { settings.lightsFlipInterval = v; }
    });
    $("#lightsFlipIntervalRed").knob({
        'release' : function (v) { settings.lightsFlipInterval = v; }
    });

    var instantSpeedContainer = $("#instantSpeed-chart-moving");
    var instantDelayContainer = $("#instantDelay-chart-moving");
    var instantStopTimesContainer = $("#instantStopTimes-chart-moving");
    var maximum = instantSpeedContainer.outerWidth() / 2 || 300;

    var data = [
            [],
            [],
            []
    ];

    function getRandomData(y_side, i) {

        if (data[i].length) {
            data[i] = data[i].slice(1);
        }

        while (data[i].length < maximum) {
            data[i].push(y_side);
        }

        // zip the generated y values with the x values

        var res = [];
        for (var j = 0; j < data[i].length; ++j) {
            res.push([j, data[i][j]])
        }

        return res;
    }

    instantSpeedContainerSeries = [{
        data: [],
        lines: {
            fill: true
        }
    }];
    instantDelayContainerSeries = [{
        data:  [],
        lines: {
            fill: true
        }
    }];
    instantStopTimesContainerSeries = [{
        data:  [],
        lines: {
            fill: true
        }
    }];

    var instantSpeedContainerplot = $.plot(instantSpeedContainer, instantSpeedContainerSeries, {
        grid: {

            color: "#999999",
            tickColor: "#D4D4D4",
            borderWidth:0,
            minBorderMargin: 20,
            labelMargin: 10,
            backgroundColor: {
                colors: ["#ffffff", "#ffffff"]
            },
            margin: {
                top: 8,
                bottom: 20,
                left: 20
            },
            markings: function(axes) {
                var markings = [];
                var xaxis = axes.xaxis;
                for (var x = Math.floor(xaxis.min); x < xaxis.max; x += xaxis.tickSize * 2) {
                    markings.push({
                        xaxis: {
                            from: x,
                            to: x + xaxis.tickSize
                        },
                        color: "#fff"
                    });
                }
                return markings;
            }
        },
        colors: ["#1ab394"],
        xaxis: {
            tickFormatter: function() {
                return "";
            }
        },
        yaxis: {
            min: 0,
            max: 50
        },
        legend: {
            show: true
        }
    });
    var instantDelayContainerplot = $.plot(instantDelayContainer, instantDelayContainerSeries, {
        grid: {

            color: "#999999",
            tickColor: "#D4D4D4",
            borderWidth:0,
            minBorderMargin: 20,
            labelMargin: 10,
            backgroundColor: {
                colors: ["#ffffff", "#ffffff"]
            },
            margin: {
                top: 8,
                bottom: 20,
                left: 20
            },
            markings: function(axes) {
                var markings = [];
                var xaxis = axes.xaxis;
                for (var x = Math.floor(xaxis.min); x < xaxis.max; x += xaxis.tickSize * 2) {
                    markings.push({
                        xaxis: {
                            from: x,
                            to: x + xaxis.tickSize
                        },
                        color: "#fff"
                    });
                }
                return markings;
            }
        },
        colors: ["#1ab394"],
        xaxis: {
            tickFormatter: function() {
                return "";
            }
        },
        yaxis: {
            min: 0,
            max: 50
        },
        legend: {
            show: true
        }
    });
    var instantStopTimesContainerplot = $.plot(instantStopTimesContainer, instantStopTimesContainerSeries, {
        grid: {

            color: "#999999",
            tickColor: "#D4D4D4",
            borderWidth:0,
            minBorderMargin: 20,
            labelMargin: 10,
            backgroundColor: {
                colors: ["#ffffff", "#ffffff"]
            },
            margin: {
                top: 8,
                bottom: 20,
                left: 20
            },
            markings: function(axes) {
                var markings = [];
                var xaxis = axes.xaxis;
                for (var x = Math.floor(xaxis.min); x < xaxis.max; x += xaxis.tickSize * 2) {
                    markings.push({
                        xaxis: {
                            from: x,
                            to: x + xaxis.tickSize
                        },
                        color: "#fff"
                    });
                }
                return markings;
            }
        },
        colors: ["#1ab394"],
        xaxis: {
            tickFormatter: function() {
                return "";
            }
        },
        yaxis: {
            min: 0,
            max: 50
        },
        legend: {
            show: true
        }
    });
    // Update the random dataset at 25FPS for a smoothly-animating chart
    setInterval(function updateRandom() {
        instantSpeedContainerSeries[0].data = getRandomData(world.instantSpeed, 0);
        instantSpeedContainerplot.setData(instantSpeedContainerSeries);
        instantSpeedContainerplot.draw();

        instantDelayContainerSeries[0].data = getRandomData(world.instantDelay, 1);
        instantDelayContainerplot.setData(instantDelayContainerSeries);
        instantDelayContainerplot.draw();

        instantStopTimesContainerSeries[0].data = getRandomData(world.instantStopDelay, 2);
        instantStopTimesContainerplot.setData(instantStopTimesContainerSeries);
        instantStopTimesContainerplot.draw();
    }, 1000);

});

    var chart = AmCharts.makeChart("chartdiv", {
        "type": "serial",
        "theme": "dark",
        "legend": {
            "equalWidths": false,
            "useGraphSettings": true,
            "valueAlign": "left",
            "valueWidth": 120
        },
        "dataProvider":[],
        "valueAxes": [{
            "id": "distanceAxis",
            "axisAlpha": 0,
            "gridAlpha": 0,
            "position": "left",
            "title": "通过车辆数"
        }, {
            "id": "latitudeAxis",
            "axisAlpha": 0,
            "gridAlpha": 0,
            "title": "平均排队长度",
            "position": "right"
        }],
        "graphs": [{
            "alphaField": "alpha",
            "balloonText": "[[value]] vel",
            "dashLengthField": "dashLength",
            "fillAlphas": 0.7,
            "legendPeriodValueText": "total: [[value.sum]] vel",
            "legendValueText": "[[value]] vel",
            "title": "通过车辆数",
            "type": "column",
            "valueField": "cap",
            "valueAxis": "distanceAxis"
        }, {
            "bullet": "square",
            "bulletBorderAlpha": 1,
            "bulletBorderThickness": 1,
            "dashLengthField": "dashLength",
            "legendValueText": "[[value]] vel",
            "title": "排队长度",
            "fillAlphas": 0,
            "valueField": "carInLane",
            "valueAxis": "latitudeAxis"
        }],
        "chartCursor": {
            "categoryBalloonDateFormat": "DD",
            "cursorAlpha": 0.1,
            "cursorColor":"#000000",
            "fullWidth":true,
            "valueBalloonsEnabled": false,
            "zoomable": false
        },
        "categoryField": "index",
        "categoryAxis": {
            "autoGridCount": false,
            "axisColor": "#555555",
            "gridAlpha": 0.1,
            "gridColor": "#FFFFFF",
            "gridCount": 50
        },
        "export": {
            "enabled": true,
//            "backgroundAlpha": 1,
            "backgroundColor": "#3F3F4F",
            "theme": AmCharts.themes.dark,
            "libs": {
                "path": "http://www.amcharts.com/lib/3/plugins/export/libs/"
            }
        }
    });

$(function() {

    var single_time;
    var circle_time = 150;
    var yellow_time = 2;
    var single_array = [];



    window.jsonMap = {};
    var selectIntersection = $('#signal-control-intersection');
    var intersectionId;
    var controlSignals;

    window.jsonResult = {};




    var realInterSection = $('#real-intersections');


    function loadSelectedIntersection() {
       intersectionId = selectIntersection.find(':selected').val();
       controlSignals = window.jsonMap.intersections[intersectionId].controlSignals;

        $("#signal1").ionRangeSlider({
            grid: true,
            type: "double",
            min: 0,
            max: circle_time,
            from: 0,
            postfix: " s",
            decorate_both: false,
            values_separator: " to ",

            onFinish:  function (data) {

                var slider = $("#signal2").data("ionRangeSlider");
                // Call sliders update method with any params
                slider.update({
                    from: data.to + parseInt(controlSignals.yellowTime)
                });

                controlSignals.timeSettings[0].start = data.from;
                controlSignals.timeSettings[0].end = data.to;

            },
            onUpdate: function (data) {
                controlSignals.timeSettings[0].start = data.from;
                controlSignals.timeSettings[0].end = data.to;
            }
        });
        $("#signal2").ionRangeSlider({
            grid: true,
            type: "double",
            min: 0,
            max: circle_time,
            from: 0,
            postfix: " s",
            decorate_both: false,
            values_separator: " to ",

            onFinish:  function (data) {

                var slider = $("#signal3").data("ionRangeSlider");
                // Call sliders update method with any params
                slider.update({
                    from: data.to + parseInt(controlSignals.yellowTime)
                });

                controlSignals.timeSettings[1].start = data.from;
                controlSignals.timeSettings[1].end = data.to;

            },

            onUpdate: function (data) {
                controlSignals.timeSettings[1].start = data.from;
                controlSignals.timeSettings[1].end = data.to;
            }

        });
        $("#signal3").ionRangeSlider({
            grid: true,
            type: "double",
            min: 0,
            max: circle_time,
            from: 0,
            postfix: " s",
            decorate_both: false,
            values_separator: " to ",

            onFinish:  function (data) {

                var slider = $("#signal4").data("ionRangeSlider");
                // Call sliders update method with any params
                slider.update({
                    from: data.to + parseInt(controlSignals.yellowTime)
                });

                controlSignals.timeSettings[2].start = data.from;
                controlSignals.timeSettings[2].end = data.to;

            },
            onUpdate: function (data) {
                controlSignals.timeSettings[2].start = data.from;
                controlSignals.timeSettings[2].end = data.to;
            }
        });

        $("#signal4").ionRangeSlider({
            grid: true,
            type: "double",
            min: 0,
            max: circle_time,
            from: 0,
            to: circle_time,
            postfix: " s",
            decorate_both: false,
            values_separator: " to ",

            onFinish:  function (data) {

                controlSignals.timeSettings[3].start = data.from;
                controlSignals.timeSettings[3].end = data.to;

            },
            onUpdate: function (data) {
                controlSignals.timeSettings[3].start = data.from;
                controlSignals.timeSettings[3].end = data.to;
            }

        });

        $('#signal-cycle').val(controlSignals.cycleTime);
        $('#signal-cycle').off().change(function() {
            controlSignals.cycleTime = $(this).val();
            _.each([1, 2, 3, 4], function(d) {
                var slider = $('#signal' + d).data("ionRangeSlider");
                slider.update({max: controlSignals.cycleTime});
            });
            $('#signal4').data("ionRangeSlider").update({to: controlSignals.cycleTime});
        });
        $('#yellow-time').val(controlSignals.yellowTime);
        $('#yellow-time').off().change(function() {
            controlSignals.yellowTime = $(this).val();
            yellow_time = parseInt(controlSignals.yellowTime)
            _.each([1, 2, 3], function(d) {
                var slider = $('#signal' + d).data("ionRangeSlider");
                var new_from = slider.old_to + parseInt(controlSignals.yellowTime);
                var nextNum = d + 1;
                $('#signal'+ nextNum).data("ionRangeSlider").update({from: new_from });
            });

        });

        _.each([1, 2, 3, 4], function(d, i) {
            var slider = $('#signal' + d);
            slider.data("ionRangeSlider").update({
                from: controlSignals.timeSettings[i].start,
                to: controlSignals.timeSettings[i].end,
                max: controlSignals.cycleTime
            });
        });
    }
    function loadIntersections() {
        selectIntersection.html('');
        _.each(window.jsonMap.realIntersection, function(intersection) {
            selectIntersection.append($('<option>', {value: intersection.id, text: intersection.id}));
        });
        selectIntersection.first('option').prop("selected", true);
        loadSelectedIntersection();
    }
    selectIntersection.change(loadSelectedIntersection);
    $('#load-json-map-btn').click(function() {
        window.jsonMap = JSON.parse($('#load-json-map-modal textarea').val());
        loadIntersections();
        $('#load-json-map-modal').modal('hide');
//        window.signalHelpVisualizer.previousTime = 0;
//        window.signalHelpWorld.load(JSON.stringify(window.jsonMap));
//        $('#signal-help').show();
    });

    function loadRealInterSectionResult(){
        intersectionId = realInterSection.find(':selected').val();
        chart.dataProvider = window.jsonResult[intersectionId];
        chart.validateData();
    }

    function loadRealInterSectionAfter(){
        realInterSection.html('');
        _.each(window.jsonMap.realIntersection, function(intersection) {
            realInterSection.append($('<option>', {value: intersection.id, text: intersection.id}));
        });
        realInterSection.first('option').prop("selected", true);
        loadRealInterSectionResult();
    }

    realInterSection.change(loadRealInterSectionResult);

    function loadResult(){
        $("#average_delay").html(Math.round(world.instantDelay * 1000) / 1000.0);
        $("#total_delay").html(Math.round(world.totalDelay / 3600 * 1000) / 1000.0);
        $("#average_speed").html(Math.round(world.instantSpeed  * 1000) / 1000.0);
        $("#total_car_number").html(Math.round(world.totalCarsNum  * 1000) / 1000.0);
        $("#average_stop_delay").html(Math.round(world.instantStopDelay * 1000) / 1000.0);
        $("#total_stop_delay").html(Math.round(world.totalStopDelay / 3600 * 1000) / 1000.0);
        $("#average_stop_times").html(Math.round(world.instantStopTimes  * 1000) / 1000.0);
        $("#total_stop_times").html(Math.round(world.totalStopCarsNum * 1000) / 1000.0);
        $("#total_stop_rate").html(Math.round(world.instantStopRate * 1000) / 10.0);
    }
    $('#start-sim').click(function() {
        isDemo = false;
       $('#sim_tab').click();
       visualizer.previousTime = 0;
       world.load(JSON.stringify(window.jsonMap));

       sim_time = parseInt($("#sim-time").val() || 3600);

       visualizer.start(false);

        var element = document.getElementById('simProgress-container');

        var seconds = new ProgressBar.Circle(element, {
            duration: 200,
            color: "#A3E1D4",
            trailColor: "#ddd",
            strokeWidth: 15,
            trailWidth: 8
        });

        var progress = 0.00;
        var sim = setInterval(function() {

            var second = world.sim_time;
            progress= Math.round(second / sim_time * 1000);
            progress = progress / 1000;
            seconds.animate(progress <1 ? progress : 1.0 , function() {
                if (second <= sim_time){
                    seconds.setText(progress * 100 + " %");
                    $("#stop_rate").val(world.instantStopRate);
                    $("#average_stop_time").val(world.instantStopTimes);
                }else{
                    seconds.setText("仿真完毕");
                    window.jsonResult = JSON.parse(world.realIntersectionData);
                    loadResult();
                    world.clear();
                    visualizer.isRunning = false;
                    window.clearInterval(sim);
                    loadRealInterSectionAfter();
                }
            });
        }, 1000);

    });
});


    </script>
</body>
</html>
